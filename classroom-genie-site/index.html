<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Classroom Genie</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts: Poppins -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- FileSaver.js for downloading files -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <!-- html-to-docx for Word document generation -->
    <script src="https://unpkg.com/html-to-docx@1.8.0/dist/html-to-docx.js"></script>
    <style>
        body {
            font-family: 'Poppins', sans-serif;
            background-color: #f8fafc;
            background-image: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23d1e5e8' fill-opacity='0.4'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
        }
        .prose { max-width: 65ch; }
        .prose-sm { font-size: 0.875rem; line-height: 1.5; }
        .worksheet-image-placeholder {
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px dashed #d1d5db;
            border-radius: 0.5rem;
            min-height: 150px;
            background-color: #f9fafb;
            color: #6b7280;
            margin: 1rem 0;
        }
        @media print {
            body * { visibility: hidden; }
            #printable-plan, #printable-plan *,
            #printable-report, #printable-report *,
            #printable-test, #printable-test *,
            #printable-worksheet, #printable-worksheet * { visibility: visible; }
            #printable-plan, #printable-report, #printable-test, #printable-worksheet {
                position: absolute; left: 0; top: 0; width: 100%; padding: 1rem; border: none;
            }
            .print-only-title { display: block !important; text-align: center; margin-bottom: 2rem; }
        }
    </style>
</head>
<body>
    <div class="min-h-screen">
        <div class="md:flex">
            <!-- Sidebar Navigation -->
            <aside id="sidebar" class="w-full md:w-64 bg-white p-4 md:h-screen md:sticky top-0 border-r border-gray-200 print:hidden flex flex-col">
                <div>
                    <div class="flex items-center mb-8">
                        <i data-lucide="brain-circuit" class="h-8 w-8 text-teal-500"></i>
                        <h1 class="ml-2 text-xl font-bold text-gray-800">Classroom Genie</h1>
                    </div>
                    <nav class="space-y-2">
                        <button data-tab="home" class="nav-link flex items-center w-full px-4 py-3 text-sm font-medium rounded-lg transition-all duration-200 bg-teal-600 text-white shadow-md">
                            <i data-lucide="home" class="h-5 w-5"></i><span class="ml-3">Home</span>
                        </button>
                        <button data-tab="lessonPlanner" class="nav-link flex items-center w-full px-4 py-3 text-sm font-medium rounded-lg transition-all duration-200 text-gray-600 hover:bg-gray-100">
                            <i data-lucide="book-open" class="h-5 w-5"></i><span class="ml-3">Lesson Plan Creator</span>
                        </button>
                        <button data-tab="reportWriter" class="nav-link flex items-center w-full px-4 py-3 text-sm font-medium rounded-lg transition-all duration-200 text-gray-600 hover:bg-gray-100">
                            <i data-lucide="file-text" class="h-5 w-5"></i><span class="ml-3">Report Writer</span>
                        </button>
                        <button data-tab="testCreator" class="nav-link flex items-center w-full px-4 py-3 text-sm font-medium rounded-lg transition-all duration-200 text-gray-600 hover:bg-gray-100">
                            <i data-lucide="file-check" class="h-5 w-5"></i><span class="ml-3">Revision Test Creator</span>
                        </button>
                         <button data-tab="worksheetCreator" class="nav-link flex items-center w-full px-4 py-3 text-sm font-medium rounded-lg transition-all duration-200 text-gray-600 hover:bg-gray-100">
                            <i data-lucide="clipboard-paste" class="h-5 w-5"></i><span class="ml-3">Worksheet Creator</span>
                        </button>
                    </nav>
                </div>
                <div class="mt-auto pt-4">
                     <label for="language-select" class="block text-sm font-medium text-gray-700 mb-1">Language</label>
                     <select id="language-select" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-teal-500 focus:border-teal-500 bg-white">
                         <option value="US" selected>US English</option>
                         <option value="UK">UK English</option>
                     </select>
                </div>
            </aside>

            <!-- Main Content -->
            <main id="main-content" class="flex-1 p-4 md:p-8"></main>
        </div>
    </div>

    <script>
        // --- STATE MANAGEMENT ---
        const state = {
            activeTab: 'home',
            reportFileContent: '',
            language: 'US'
        };
        const mainContent = document.getElementById('main-content');
        const navLinks = document.querySelectorAll('.nav-link');

        // --- TEMPLATES / VIEWS ---
        const homePageTemplate = `
            <div class="max-w-4xl mx-auto">
                <div class="bg-white p-8 md:p-12 rounded-xl shadow-xl border-t-4 border-teal-500 text-center">
                    <i data-lucide="sparkles" class="mx-auto h-16 w-16 text-teal-400"></i>
                    <h1 class="mt-4 text-4xl md:text-5xl font-bold text-gray-800">Welcome to Classroom Genie</h1>
                    <p class="mt-4 text-lg text-gray-600 max-w-2xl mx-auto">
                        Your ultimate AI-powered assistant for teaching. Save time on administrative tasks and focus on what truly matters: inspiring your students. Explore our free tools for lesson planning, report writing, and test creation.
                    </p>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mt-10">
                    <div data-tab-link="lessonPlanner" class="group bg-white p-8 rounded-xl shadow-lg hover:shadow-2xl transition-shadow duration-300 cursor-pointer border-t-4 border-purple-400">
                        <i data-lucide="book-open" class="h-12 w-12 text-purple-500 mb-4"></i>
                        <h2 class="text-2xl font-bold text-gray-800">Lesson Plan Creator</h2>
                        <p class="mt-2 text-gray-600">Effortlessly generate detailed, engaging lesson plans tailored to your topic, objectives, and time constraints.</p>
                        <div class="flex items-center mt-6 font-semibold text-purple-600"><span>Start Planning</span><i data-lucide="arrow-right" class="ml-2 h-5 w-5 transition-transform duration-300 group-hover:translate-x-1"></i></div>
                    </div>
                    <div data-tab-link="reportWriter" class="group bg-white p-8 rounded-xl shadow-lg hover:shadow-2xl transition-shadow duration-300 cursor-pointer border-t-4 border-orange-400">
                        <i data-lucide="file-text" class="h-12 w-12 text-orange-500 mb-4"></i>
                        <h2 class="text-2xl font-bold text-gray-800">Report Writer</h2>
                        <p class="mt-2 text-gray-600">Upload student marks and add your comments to generate comprehensive, personalized school reports automatically.</p>
                        <div class="flex items-center mt-6 font-semibold text-orange-600"><span>Write Reports</span><i data-lucide="arrow-right" class="ml-2 h-5 w-5 transition-transform duration-300 group-hover:translate-x-1"></i></div>
                    </div>
                    <div data-tab-link="testCreator" class="group bg-white p-8 rounded-xl shadow-lg hover:shadow-2xl transition-shadow duration-300 cursor-pointer border-t-4 border-blue-400">
                        <i data-lucide="file-check" class="h-12 w-12 text-blue-500 mb-4"></i>
                        <h2 class="text-2xl font-bold text-gray-800">Revision Test Creator</h2>
                        <p class="mt-2 text-gray-600">Quickly create revision tests on any topic, with various question types, to help your students prepare and succeed.</p>
                        <div class="flex items-center mt-6 font-semibold text-blue-600"><span>Create a Test</span><i data-lucide="arrow-right" class="ml-2 h-5 w-5 transition-transform duration-300 group-hover:translate-x-1"></i></div>
                    </div>
                     <div data-tab-link="worksheetCreator" class="group bg-white p-8 rounded-xl shadow-lg hover:shadow-2xl transition-shadow duration-300 cursor-pointer border-t-4 border-green-400">
                        <i data-lucide="clipboard-paste" class="h-12 w-12 text-green-500 mb-4"></i>
                        <h2 class="text-2xl font-bold text-gray-800">Worksheet Creator</h2>
                        <p class="mt-2 text-gray-600">Design beautiful, age-appropriate worksheets with varied activities to engage every learner in your classroom.</p>
                        <div class="flex items-center mt-6 font-semibold text-green-600"><span>Create a Worksheet</span><i data-lucide="arrow-right" class="ml-2 h-5 w-5 transition-transform duration-300 group-hover:translate-x-1"></i></div>
                    </div>
                </div>
            </div>`;

        const lessonPlannerTemplate = `
            <div class="max-w-4xl mx-auto">
                <div class="bg-white p-8 rounded-xl shadow-xl border-t-4 border-teal-500 print:hidden">
                    <h2 class="text-3xl font-bold text-gray-800 mb-2">Lesson Plan Creator</h2>
                    <p class="text-gray-500 mb-8">Design engaging lesson plans with AI-suggested web resources.</p>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                        <div class="md:col-span-2"><label for="topic" class="block text-sm font-medium text-gray-700 mb-1">Topic</label><input type="text" id="topic" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-teal-500 focus:border-teal-500" placeholder="e.g., The Water Cycle"></div>
                        <div>
                            <label for="duration-select" class="block text-sm font-medium text-gray-700 mb-1">Duration</label>
                            <select id="duration-select" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-teal-500 focus:border-teal-500 bg-white">
                                <option value="20">20 minutes</option>
                                <option value="30">30 minutes</option>
                                <option value="45" selected>45 minutes</option>
                                <option value="60">1 hour</option>
                                <option value="custom">Custom</option>
                            </select>
                        </div>
                        <div id="custom-duration-wrapper" class="hidden">
                            <label for="duration-custom" class="block text-sm font-medium text-gray-700 mb-1">Minutes</label>
                            <input type="number" id="duration-custom" value="45" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-teal-500 focus:border-teal-500">
                        </div>
                        <div class="md:col-span-2"><label for="objectives" class="block text-sm font-medium text-gray-700 mb-1">Learning Objectives</label><textarea id="objectives" rows="3" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-teal-500 focus:border-teal-500" placeholder="e.g., Students will be able to name the stages of the water cycle."></textarea></div>
                    </div>
                    <button id="generate-plan-btn" class="w-full bg-teal-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-teal-700 transition-all duration-300 transform hover:scale-105 flex items-center justify-center disabled:bg-teal-300 disabled:scale-100 mb-8"><i data-lucide="sparkles" class="w-5 h-5 mr-2"></i>Generate Lesson Plan</button>
                    <div id="lp-error" class="text-red-500 text-sm mt-2 mb-6 hidden"></div>
                </div>
                <div id="lp-output" class="mt-8">
                    <div class="text-center p-12 bg-white rounded-xl shadow-lg border-t-4 border-gray-200">
                        <i data-lucide="lightbulb" class="mx-auto h-16 w-16 text-gray-300"></i>
                        <h3 class="mt-4 text-lg font-semibold text-gray-700">Your masterpiece awaits!</h3>
                        <p class="mt-1 text-gray-500">Fill out the form above to create your lesson plan.</p>
                    </div>
                </div>
            </div>`;

        const reportWriterTemplate = `
            <div class="max-w-4xl mx-auto">
                <div class="bg-white p-8 rounded-xl shadow-xl border-t-4 border-teal-500 print:hidden">
                    <h2 class="text-3xl font-bold text-gray-800 mb-2">Report Writer</h2>
                    <p class="text-gray-500 mb-8">Generate student reports from marks and your insights.</p>
                    <div class="space-y-6 mb-8">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Upload Marks</label>
                            <div class="mt-1 flex justify-center px-6 pt-5 pb-6 border-2 border-gray-300 border-dashed rounded-md"><div class="space-y-1 text-center"><i data-lucide="upload-cloud" class="mx-auto h-12 w-12 text-gray-400"></i><div class="flex text-sm text-gray-600"><label for="file-upload" class="relative cursor-pointer bg-white rounded-md font-medium text-teal-600 hover:text-teal-500 focus-within:outline-none focus-within:ring-2 focus-within:ring-offset-2 focus-within:ring-teal-500"><span>Upload a file</span><input id="file-upload" type="file" class="sr-only" accept=".pdf,.xls,.xlsx,.csv,.doc,.docx,.txt"></label><p class="pl-1">or drag and drop</p></div><p class="text-xs text-gray-500">PDF, Excel, CSV, Word up to 10MB</p></div></div>
                            <div id="file-info" class="hidden items-center justify-between bg-gray-100 p-2 rounded-lg mt-2">
                                <span id="file-name" class="text-sm text-gray-700 truncate"></span>
                                <button id="remove-file-btn" class="p-1 rounded-full hover:bg-red-100 text-gray-500 hover:text-red-600 transition-colors">
                                    <i data-lucide="x" class="h-4 w-4"></i>
                                </button>
                            </div>
                        </div>
                        <div><label for="studentName" class="block text-sm font-medium text-gray-700 mb-1">Student's Name</label><input type="text" id="studentName" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-teal-500 focus:border-teal-500" placeholder="e.g., Jane Doe"></div>
                        <div><label for="comments" class="block text-sm font-medium text-gray-700 mb-1">Additional Comments for Narrative Report</label><p class="text-sm text-gray-500 mb-2">Highly recommended. Adding your own insights helps the AI write a much richer, more personalized report.</p><textarea id="comments" rows="4" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-teal-500 focus:border-teal-500" placeholder="e.g., 'Shows great enthusiasm...'"></textarea></div>
                    </div>
                    <button id="generate-report-btn" class="w-full bg-teal-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-teal-700 transition-all duration-300 transform hover:scale-105 flex items-center justify-center disabled:bg-teal-300 disabled:scale-100"><i data-lucide="file-text" class="w-5 h-5 mr-2"></i>Generate Report</button>
                    <div id="rw-error" class="text-red-500 text-sm mt-2 hidden"></div>
                </div>
                <div id="rw-output" class="mt-8">
                    <div class="text-center p-12 bg-white rounded-xl shadow-lg border-t-4 border-gray-200">
                        <i data-lucide="lightbulb" class="mx-auto h-16 w-16 text-gray-300"></i>
                        <h3 class="mt-4 text-lg font-semibold text-gray-700">Your report will appear here.</h3>
                        <p class="mt-1 text-gray-500">Fill out the form above to get started.</p>
                    </div>
                </div>
            </div>`;
        
        const testCreatorTemplate = `
            <div class="max-w-4xl mx-auto">
                <div class="bg-white p-8 rounded-xl shadow-xl border-t-4 border-teal-500 print:hidden">
                    <h2 class="text-3xl font-bold text-gray-800 mb-2">Revision Test Creator</h2>
                    <p class="text-gray-500 mb-8">Generate a revision test with various question types for any topic.</p>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                        <div class="md:col-span-2">
                            <label for="test-topic" class="block text-sm font-medium text-gray-700 mb-1">Topic</label>
                            <textarea id="test-topic" rows="3" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-teal-500 focus:border-teal-500" placeholder="e.g., The Roman Empire, including the rise and fall, key emperors, and major architectural achievements."></textarea>
                        </div>
                        <div class="flex items-end space-x-4">
                            <div>
                                <label for="num-questions-select" class="block text-sm font-medium text-gray-700 mb-1">Number of Questions</label>
                                <select id="num-questions-select" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-teal-500 focus:border-teal-500 bg-white">
                                    <option value="10" selected>10</option>
                                    <option value="15">15</option>
                                    <option value="20">20</option>
                                    <option value="custom">Custom</option>
                                </select>
                            </div>
                            <div id="custom-questions-wrapper" class="hidden flex-1">
                                <label for="num-questions-custom" class="block text-sm font-medium text-gray-700 mb-1">Custom</label>
                                <input type="number" id="num-questions-custom" value="10" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-teal-500 focus:border-teal-500">
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Question Types</label>
                            <div class="space-y-2 mt-2">
                                <label class="flex items-center"><input type="checkbox" id="qt-mcq" class="h-4 w-4 text-teal-600 border-gray-300 rounded focus:ring-teal-500" checked> <span class="ml-2 text-sm text-gray-700">Multiple Choice</span></label>
                                <label class="flex items-center"><input type="checkbox" id="qt-tf" class="h-4 w-4 text-teal-600 border-gray-300 rounded focus:ring-teal-500"> <span class="ml-2 text-sm text-gray-700">True/False</span></label>
                                <label class="flex items-center"><input type="checkbox" id="qt-short" class="h-4 w-4 text-teal-600 border-gray-300 rounded focus:ring-teal-500"> <span class="ml-2 text-sm text-gray-700">Short Answer</span></label>
                            </div>
                        </div>
                    </div>
                    <button id="generate-test-btn" class="w-full bg-teal-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-teal-700 transition-all duration-300 transform hover:scale-105 flex items-center justify-center disabled:bg-teal-300 disabled:scale-100 mb-8"><i data-lucide="sparkles" class="w-5 h-5 mr-2"></i>Generate Test</button>
                    <div id="tc-error" class="text-red-500 text-sm mt-2 mb-6 hidden"></div>
                </div>
                <div id="tc-output" class="mt-8">
                    <div class="text-center p-12 bg-white rounded-xl shadow-lg border-t-4 border-gray-200">
                        <i data-lucide="lightbulb" class="mx-auto h-16 w-16 text-gray-300"></i>
                        <h3 class="mt-4 text-lg font-semibold text-gray-700">Your test will appear here.</h3>
                        <p class="mt-1 text-gray-500">Fill out the form above to create a revision test.</p>
                    </div>
                </div>
            </div>`;
        
        const worksheetCreatorTemplate = `
            <div class="max-w-4xl mx-auto">
                <div class="bg-white p-8 rounded-xl shadow-xl border-t-4 border-teal-500 print:hidden">
                    <h2 class="text-3xl font-bold text-gray-800 mb-2">Worksheet Creator</h2>
                    <p class="text-gray-500 mb-8">Design engaging, age-appropriate worksheets for any topic.</p>
                    <div class="space-y-6 mb-8">
                        <div>
                            <label for="ws-grade" class="block text-sm font-medium text-gray-700 mb-1">Grade Level</label>
                            <select id="ws-grade" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-teal-500 focus:border-teal-500 bg-white">
                                <option value="Kindergarten-Grade 1">Kindergarten - Grade 1</option>
                                <option value="Grade 2-3">Grades 2-3</option>
                                <option value="Grade 4-6" selected>Grades 4-6</option>
                                <option value="Grade 7-9">Grades 7-9</option>
                            </select>
                        </div>
                        <div>
                            <label for="ws-topic" class="block text-sm font-medium text-gray-700 mb-1">Topic & Instructions</label>
                            <textarea id="ws-topic" rows="4" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-teal-500 focus:border-teal-500" placeholder="e.g., The basics of photosynthesis. Include a diagram to label and a fill-in-the-blanks section."></textarea>
                        </div>
                    </div>
                    <button id="generate-worksheet-btn" class="w-full bg-teal-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-teal-700 transition-all duration-300 transform hover:scale-105 flex items-center justify-center disabled:bg-teal-300 disabled:scale-100 mb-8"><i data-lucide="sparkles" class="w-5 h-5 mr-2"></i>Generate Worksheet</button>
                    <div id="ws-error" class="text-red-500 text-sm mt-2 mb-6 hidden"></div>
                </div>
                <div id="ws-output" class="mt-8">
                    <div class="text-center p-12 bg-white rounded-xl shadow-lg border-t-4 border-gray-200">
                        <i data-lucide="lightbulb" class="mx-auto h-16 w-16 text-gray-300"></i>
                        <h3 class="mt-4 text-lg font-semibold text-gray-700">Your worksheet will appear here.</h3>
                        <p class="mt-1 text-gray-500">Fill out the form above to get started.</p>
                    </div>
                </div>
            </div>`;

        // --- RENDER & NAVIGATION ---
        function render() {
            if (state.activeTab === 'home') mainContent.innerHTML = homePageTemplate;
            else if (state.activeTab === 'lessonPlanner') mainContent.innerHTML = lessonPlannerTemplate;
            else if (state.activeTab === 'reportWriter') mainContent.innerHTML = reportWriterTemplate;
            else if (state.activeTab === 'testCreator') mainContent.innerHTML = testCreatorTemplate;
            else if (state.activeTab === 'worksheetCreator') mainContent.innerHTML = worksheetCreatorTemplate;
            updateNavLinks();
            lucide.createIcons();
        }

        function updateNavLinks() {
            navLinks.forEach(link => {
                if (link.dataset.tab === state.activeTab) {
                    link.classList.add('bg-teal-600', 'text-white', 'shadow-md');
                    link.classList.remove('text-gray-600', 'hover:bg-gray-100');
                } else {
                    link.classList.remove('bg-teal-600', 'text-white', 'shadow-md');
                    link.classList.add('text-gray-600', 'hover:bg-gray-100');
                }
            });
        }
        
        // --- EVENT HANDLING (using delegation) ---
        document.addEventListener('click', (e) => {
            const navLink = e.target.closest('.nav-link');
            if (navLink) { state.activeTab = navLink.dataset.tab; render(); return; }
            
            const tabLink = e.target.closest('[data-tab-link]');
            if (tabLink) { state.activeTab = tabLink.dataset.tabLink; render(); return; }
            
            if (e.target.closest('#generate-plan-btn')) handleGenerateLessonPlan();
            if (e.target.closest('#generate-report-btn')) handleGenerateReport();
            if (e.target.closest('#generate-test-btn')) handleGenerateTest();
            if (e.target.closest('#generate-worksheet-btn')) handleGenerateWorksheet();
            if (e.target.closest('#remove-file-btn')) handleRemoveFile();

            const downloadBtn = e.target.closest('[data-action="download"]');
            if (downloadBtn) handleDownloadDoc(downloadBtn.dataset.filename);
            
            const printBtn = e.target.closest('[data-action="print"]');
            if (printBtn) window.print();
        });

        document.addEventListener('change', (e) => {
            if (e.target.id === 'language-select') {
                state.language = e.target.value;
            }
        });

        mainContent.addEventListener('change', (e) => {
            if (e.target.id === 'file-upload') handleFileChange(e);
            if (e.target.id === 'duration-select') {
                document.getElementById('custom-duration-wrapper').classList.toggle('hidden', e.target.value !== 'custom');
            }
            if (e.target.id === 'num-questions-select') {
                document.getElementById('custom-questions-wrapper').classList.toggle('hidden', e.target.value !== 'custom');
            }
        });
        
        // --- API & BUSINESS LOGIC ---
        
        async function fetchWithRetry(prompt, isJson, retries = 1, requestType = 'text') {
            try {
                const response = await fetch('/.netlify/functions/generate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ prompt, isJson, requestType })
                });
                if (!response.ok) throw new Error(`API request failed with status ${response.status}`);
                
                const result = await response.json();

                if (requestType === 'image') {
                    const imageUrl = `data:image/png;base64,${result.predictions[0].bytesBase64Encoded}`;
                    if (!imageUrl) throw new Error("Image generation failed.");
                    return imageUrl;
                }
                
                const text = result.candidates?.[0]?.content?.parts?.[0]?.text;
                if (!text) {
                    throw new Error("The AI returned an empty or invalid response.");
                }
                return text;

            } catch (error) {
                if (retries > 0) {
                    console.warn("Request failed, retrying...", error);
                    await new Promise(resolve => setTimeout(resolve, 500));
                    return fetchWithRetry(prompt, isJson, retries - 1, requestType);
                }
                throw error;
            }
        }

        function handleFileChange(e) {
            const file = e.target.files[0];
            if (!file) return;
            const fileInfoEl = document.getElementById('file-info');
            const fileNameEl = document.getElementById('file-name');
            fileNameEl.textContent = file.name;
            fileInfoEl.classList.remove('hidden');
            fileInfoEl.classList.add('flex');
            
            const reader = new FileReader();
            reader.onload = (event) => { state.reportFileContent = event.target.result; };
            reader.readAsText(file);
        }

        function handleRemoveFile() {
            state.reportFileContent = '';
            const fileInfoEl = document.getElementById('file-info');
            const fileInput = document.getElementById('file-upload');
            fileInfoEl.classList.add('hidden');
            fileInfoEl.classList.remove('flex');
            fileInput.value = null; 
        }

        async function handleGenerateLessonPlan() {
            const topic = document.getElementById('topic').value;
            const objectives = document.getElementById('objectives').value;
            const durationSelect = document.getElementById('duration-select');
            let duration = durationSelect.value;
            if (duration === 'custom') {
                duration = document.getElementById('duration-custom').value;
            }
            const language = state.language;
            const errorEl = document.getElementById('lp-error');
            const outputEl = document.getElementById('lp-output');
            const button = document.getElementById('generate-plan-btn');

            errorEl.classList.add('hidden');
            if (!topic || !objectives) {
                errorEl.textContent = 'Please fill in the Topic and Learning Objectives.';
                errorEl.classList.remove('hidden');
                return;
            }

            button.disabled = true;
            button.innerHTML = `<div class="animate-spin rounded-full h-5 w-5 border-b-2 border-white mr-3"></div> Generating...`;
            outputEl.innerHTML = `<div class="text-center text-gray-600"><p>Crafting your lesson plan...</p></div>`;

            const prompt = `Create a detailed lesson plan for a ${duration}-minute lesson. Topic: ${topic}. Learning Objectives: ${objectives}. Language: ${language} English. Format the response using these exact markdown headings: ## Introduction, ## Main Activities, ## Plenary, ## Resources, ## Visual Aid Ideas`;

            try {
                const text = await fetchWithRetry(prompt, false);
                const plan = parseLessonPlan(text);
                const webResources = getWebResources(topic);
                
                const getHighlight = (text, length = 70) => {
                    if (!text) return 'No details provided.';
                    const sentence = text.split('.')[0];
                    return sentence.length > length ? sentence.substring(0, length) + '...' : sentence;
                };

                const timelineHTML = `
                    <div class="flex items-start text-center bg-white p-4 rounded-lg shadow-sm border border-gray-200 mb-6 space-x-4">
                        <div class="flex-1">
                            <i data-lucide="flag" class="mx-auto h-6 w-6 text-green-500"></i>
                            <p class="text-xs mt-1 font-bold">Introduction</p>
                            <p class="text-xs mt-1 text-gray-500">${getHighlight(plan.introduction)}</p>
                        </div>
                        <div class="w-px bg-gray-300 self-stretch"></div>
                        <div class="flex-1">
                            <i data-lucide="list-checks" class="mx-auto h-6 w-6 text-blue-500"></i>
                            <p class="text-xs mt-1 font-bold">Main Activities</p>
                            <p class="text-xs mt-1 text-gray-500">${getHighlight(plan.mainActivities)}</p>
                        </div>
                        <div class="w-px bg-gray-300 self-stretch"></div>
                        <div class="flex-1">
                            <i data-lucide="award" class="mx-auto h-6 w-6 text-purple-500"></i>
                            <p class="text-xs mt-1 font-bold">Plenary</p>
                            <p class="text-xs mt-1 text-gray-500">${getHighlight(plan.plenary)}</p>
                        </div>
                    </div>
                `;

                const printableContent = `
                    <h1 class="text-3xl font-bold text-center">Lesson Plan: ${topic}</h1>
                    ${createSectionHTML('target', 'green', 'Introduction', plan.introduction)}
                    ${createSectionHTML('list-checks', 'blue', 'Main Activities', plan.mainActivities)}
                    ${createSectionHTML('flag', 'purple', 'Plenary / Conclusion', plan.plenary)}
                    ${createSectionHTML('paperclip', 'orange', 'Resources', plan.resources)}
                `;
                
                outputEl.innerHTML = `
                    <div class="bg-gray-50/50 p-6 rounded-lg">
                        <div class="flex justify-between items-center mb-6 print:hidden">
                            <h2 class="text-2xl font-bold text-gray-800">Your Lesson Plan</h2>
                            <div class="flex space-x-2">
                                <button data-action="download" data-filename="${`Lesson Plan - ${topic}`.replace(/"/g, '&quot;')}" class="flex items-center bg-gray-200 text-gray-800 font-semibold py-2 px-4 rounded-lg hover:bg-gray-300 transition-colors"><i data-lucide="download" class="w-5 h-5 mr-2"></i>Download</button>
                                <button data-action="print" class="flex items-center bg-gray-200 text-gray-800 font-semibold py-2 px-4 rounded-lg hover:bg-gray-300 transition-colors"><i data-lucide="printer" class="w-5 h-5 mr-2"></i>Print</button>
                            </div>
                        </div>
                        ${timelineHTML}
                        <div id="printable-plan" class="space-y-6">${printableContent}</div>
                        <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200 mt-6 print:hidden">
                            <h3 class="text-lg font-semibold text-gray-800 flex items-center mb-4"><i data-lucide="video" class="text-pink-500"></i><span class="ml-2">Web Resources & Videos</span></h3>
                            <ul class="space-y-4">${webResources.map(r => `
                                <li class="border-b border-gray-200 pb-3 last:border-b-0">
                                    <a href="${r.url}" target="_blank" rel="noopener noreferrer" class="font-semibold text-teal-600 hover:underline">${r.title}</a>
                                    <p class="text-sm text-gray-500 mt-1">${r.snippet}</p>
                                </li>`).join('')}
                            </ul>
                        </div>
                    </div>`;
                lucide.createIcons();
            } catch (e) {
                errorEl.textContent = `An error occurred: ${e.message}`;
                errorEl.classList.remove('hidden');
                outputEl.innerHTML = '';
            } finally {
                button.disabled = false;
                button.innerHTML = `<i data-lucide="sparkles" class="w-5 h-5 mr-2"></i>Generate Lesson Plan`;
                lucide.createIcons();
            }
        }

        async function handleGenerateReport() {
            const studentName = document.getElementById('studentName').value;
            const comments = document.getElementById('comments').value;
            const fileContent = state.reportFileContent || '';
            const errorEl = document.getElementById('rw-error');
            const outputEl = document.getElementById('rw-output');
            const button = document.getElementById('generate-report-btn');

            errorEl.classList.add('hidden');
            if (!fileContent) { errorEl.textContent = 'Please upload a marks document.'; errorEl.classList.remove('hidden'); return; }
            if (!studentName) { errorEl.textContent = "Please enter the student's name."; errorEl.classList.remove('hidden'); return; }

            button.disabled = true;
            button.innerHTML = `<div class="animate-spin rounded-full h-5 w-5 border-b-2 border-white mr-3"></div> Generating...`;
            outputEl.innerHTML = `<div class="text-center text-gray-600"><p>Generating your report...</p></div>`;

            const prompt = `Based on the student data and teacher comments for ${studentName}, generate a JSON object with two keys: "marks_analysis" and "narrative_report". 1. "marks_analysis": Briefly summarize the key takeaways from the marks data in a few bullet points. 2. "narrative_report": Write a comprehensive and detailed school report that integrates the teacher's comments, analyzes the marks data, and concludes with areas for improvement. Maintain an encouraging tone. Do not use markdown. Student Marks Data: --- ${fileContent} --- Additional Teacher Comments: --- ${comments} ---`;

            try {
                const jsonText = await fetchWithRetry(prompt, true);
                const parsedResult = JSON.parse(jsonText);

                let narrativeReport = "No narrative report could be generated.";
                let marksAnalysis = "No marks analysis could be generated.";
                for (const key in parsedResult) {
                    const lowerKey = key.toLowerCase();
                    if (lowerKey.includes('narrative')) narrativeReport = parsedResult[key];
                    if (lowerKey.includes('marks')) marksAnalysis = parsedResult[key];
                }
                
                const printableContent = `
                    <h1 class="text-3xl font-bold text-center">School Report for ${studentName}</h1>
                    ${createSectionHTML('message-square', 'purple', 'Narrative Report', narrativeReport)}
                    ${createSectionHTML('bar-chart-2', 'teal', 'Marks Analysis', marksAnalysis)}
                `;
                
                outputEl.innerHTML = `
                    <div class="bg-gray-50/50 p-6 rounded-lg">
                        <div class="flex justify-between items-center mb-6 print:hidden">
                            <h2 class="text-2xl font-bold text-gray-800">Generated Report</h2>
                            <div class="flex space-x-2">
                                <button data-action="download" data-filename="Report for ${studentName.replace(/"/g, '&quot;')}" class="flex items-center bg-gray-200 text-gray-800 font-semibold py-2 px-4 rounded-lg hover:bg-gray-300 transition-colors"><i data-lucide="download" class="w-5 h-5 mr-2"></i>Download</button>
                                <button data-action="print" class="flex items-center bg-gray-200 text-gray-800 font-semibold py-2 px-4 rounded-lg hover:bg-gray-300 transition-colors"><i data-lucide="printer" class="w-5 h-5 mr-2"></i>Print</button>
                            </div>
                        </div>
                        <div id="printable-report" class="space-y-6">${printableContent}</div>
                    </div>`;
                lucide.createIcons();
            } catch (e) {
                errorEl.textContent = `An error occurred: ${e.message}`;
                errorEl.classList.remove('hidden');
                outputEl.innerHTML = '';
            } finally {
                button.disabled = false;
                button.innerHTML = `<i data-lucide="file-text" class="w-5 h-5 mr-2"></i>Generate Report`;
                lucide.createIcons();
            }
        }

        async function handleGenerateTest() {
            const topic = document.getElementById('test-topic').value;
            const numQuestionsSelect = document.getElementById('num-questions-select');
            let numQuestions = numQuestionsSelect.value;
            if (numQuestions === 'custom') {
                numQuestions = document.getElementById('num-questions-custom').value;
            }
            const errorEl = document.getElementById('tc-error');
            const outputEl = document.getElementById('tc-output');
            const button = document.getElementById('generate-test-btn');

            const questionTypes = [];
            if (document.getElementById('qt-mcq').checked) questionTypes.push('multiple-choice');
            if (document.getElementById('qt-tf').checked) questionTypes.push('true/false');
            if (document.getElementById('qt-short').checked) questionTypes.push('short answer');

            errorEl.classList.add('hidden');
            if (!topic || questionTypes.length === 0) {
                errorEl.textContent = 'Please provide a topic and select at least one question type.';
                errorEl.classList.remove('hidden');
                return;
            }

            button.disabled = true;
            button.innerHTML = `<div class="animate-spin rounded-full h-5 w-5 border-b-2 border-white mr-3"></div> Generating...`;
            outputEl.innerHTML = `<div class="text-center text-gray-600"><p>Creating your revision test...</p></div>`;

            const prompt = `Create a revision test for a student. Topic: ${topic}. Number of questions: ${numQuestions}. Question types: ${questionTypes.join(', ')}. The output must be a JSON object with two keys: "questions" and "answers". "questions" should be an array of strings, where each string is a full question (including options for multiple-choice). "answers" should be an array of strings providing the correct answer for each corresponding question.`;

            try {
                const jsonText = await fetchWithRetry(prompt, true);
                const parsedResult = JSON.parse(jsonText);

                const questions = parsedResult.questions || [];
                const answers = parsedResult.answers || [];

                const printableContent = `
                    <h1 class="text-3xl font-bold text-center">Revision Test: ${topic}</h1>
                    <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200 break-inside-avoid">
                        <h3 class="text-lg font-semibold text-gray-800 flex items-center mb-3"><i data-lucide="file-check-2" class="text-blue-500"></i><span class="ml-2">Questions</span></h3>
                        <ol class="list-decimal list-inside space-y-4 prose prose-sm max-w-none text-gray-700">${questions.map(q => `<li>${q.replace(/\n/g, '<br>')}</li>`).join('')}</ol>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200 break-inside-avoid">
                        <h3 class="text-lg font-semibold text-gray-800 flex items-center mb-3"><i data-lucide="key-round" class="text-green-500"></i><span class="ml-2">Answer Key</span></h3>
                        <ol class="list-decimal list-inside space-y-2 prose prose-sm max-w-none text-gray-700">${answers.map(a => `<li>${a}</li>`).join('')}</ol>
                    </div>
                `;
                
                outputEl.innerHTML = `
                    <div class="bg-gray-50/50 p-6 rounded-lg">
                        <div class="flex justify-between items-center mb-6 print:hidden">
                            <h2 class="text-2xl font-bold text-gray-800">Generated Test</h2>
                            <div class="flex space-x-2">
                                <button data-action="download" data-filename="Revision Test - ${topic.replace(/"/g, '&quot;')}" class="flex items-center bg-gray-200 text-gray-800 font-semibold py-2 px-4 rounded-lg hover:bg-gray-300 transition-colors"><i data-lucide="download" class="w-5 h-5 mr-2"></i>Download</button>
                                <button data-action="print" class="flex items-center bg-gray-200 text-gray-800 font-semibold py-2 px-4 rounded-lg hover:bg-gray-300 transition-colors"><i data-lucide="printer" class="w-5 h-5 mr-2"></i>Print</button>
                            </div>
                        </div>
                        <div id="printable-test" class="space-y-6">${printableContent}</div>
                    </div>`;
                lucide.createIcons();

            } catch (e) {
                errorEl.textContent = `An error occurred: ${e.message}`;
                errorEl.classList.remove('hidden');
                outputEl.innerHTML = '';
            } finally {
                button.disabled = false;
                button.innerHTML = `<i data-lucide="sparkles" class="w-5 h-5 mr-2"></i>Generate Test`;
                lucide.createIcons();
            }
        }

        async function handleGenerateWorksheet() {
            const topic = document.getElementById('ws-topic').value;
            const grade = document.getElementById('ws-grade').value;
            const errorEl = document.getElementById('ws-error');
            const outputEl = document.getElementById('ws-output');
            const button = document.getElementById('generate-worksheet-btn');

            errorEl.classList.add('hidden');
            if (!topic) {
                errorEl.textContent = 'Please provide a topic and instructions.';
                errorEl.classList.remove('hidden');
                return;
            }

            button.disabled = true;
            button.innerHTML = `<div class="animate-spin rounded-full h-5 w-5 border-b-2 border-white mr-3"></div> Generating...`;
            outputEl.innerHTML = `<div class="text-center text-gray-600"><p>Designing your worksheet...</p></div>`;

            const textPrompt = `Create a 1-page worksheet for a ${grade} student. The main topic is: "${topic}". The output must be a JSON object with three keys: "title", "worksheet_content", and "image_prompts". "title" should be a short title for the worksheet. "worksheet_content" should be the full markdown text of the worksheet, including unique placeholders for each image like [IMAGE_1], [IMAGE_2], etc. "image_prompts" should be an array of 2-3 simple, clear prompts for an image generation model to create educational illustrations for the corresponding placeholders (e.g., "A simple diagram of the water cycle", "A cartoon sun smiling"). Also generate a separate answer key within the worksheet_content under a "## Answer Key" heading.`;

            try {
                const jsonText = await fetchWithRetry(textPrompt, true, 1, 'text');
                const parsedResult = JSON.parse(jsonText);
                
                let worksheetContent = parsedResult.worksheet_content || '';
                const imagePrompts = parsedResult.image_prompts || [];
                const title = parsedResult.title || 'Worksheet';

                outputEl.innerHTML = `<div class="text-center text-gray-600"><p>Generating images (1/${imagePrompts.length})...</p></div>`;
                
                const imageUrls = [];
                for (let i = 0; i < imagePrompts.length; i++) {
                    outputEl.innerHTML = `<div class="text-center text-gray-600"><p>Generating images (${i + 1}/${imagePrompts.length})...</p></div>`;
                    const imagePrompt = `simple, clear, colorful diagram for a children's worksheet. Style: friendly cartoon, educational. Subject: ${imagePrompts[i]}`;
                    const imageUrl = await fetchWithRetry(imagePrompt, false, 1, 'image');
                    imageUrls.push(imageUrl);
                }

                imageUrls.forEach((url, i) => {
                    worksheetContent = worksheetContent.replace(`[IMAGE_${i + 1}]`, `<img src="${url}" alt="${imagePrompts[i]}" class="my-4 rounded-lg shadow-md border border-gray-200" />`);
                });
                
                const answerKeyContent = worksheetContent.split('## Answer Key')[1] || 'No answer key provided.';
                worksheetContent = worksheetContent.split('## Answer Key')[0];

                const printableContent = `
                    <div class="p-6 border rounded-lg bg-white">
                        <div class="flex justify-between items-center border-b pb-4">
                            <h1 class="text-2xl font-bold">${title}</h1>
                            <div class="text-sm"><strong>Name:</strong> _________________________</div>
                        </div>
                        <div class="prose max-w-none mt-4">${worksheetContent.replace(/## /g, '<h3 class="text-lg font-semibold mt-6 mb-2">').replace(/\n/g, '<br>')}</div>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200 break-inside-avoid mt-6">
                        <h3 class="text-lg font-semibold text-gray-800 flex items-center mb-3"><i data-lucide="key-round" class="text-green-500"></i><span class="ml-2">Answer Key</span></h3>
                        <div class="prose prose-sm max-w-none text-gray-600">${answerKeyContent.replace(/\n/g, '<br>')}</div>
                    </div>
                `;
                
                outputEl.innerHTML = `
                    <div class="bg-gray-50/50 p-6 rounded-lg">
                        <div class="flex justify-between items-center mb-6 print:hidden">
                            <h2 class="text-2xl font-bold text-gray-800">Generated Worksheet</h2>
                            <div class="flex space-x-2">
                                <button data-action="download" data-filename="Worksheet - ${title.replace(/"/g, '&quot;')}" class="flex items-center bg-gray-200 text-gray-800 font-semibold py-2 px-4 rounded-lg hover:bg-gray-300 transition-colors"><i data-lucide="download" class="w-5 h-5 mr-2"></i>Download</button>
                                <button data-action="print" class="flex items-center bg-gray-200 text-gray-800 font-semibold py-2 px-4 rounded-lg hover:bg-gray-300 transition-colors"><i data-lucide="printer" class="w-5 h-5 mr-2"></i>Print</button>
                            </div>
                        </div>
                        <div id="printable-worksheet">${printableContent}</div>
                    </div>`;
                lucide.createIcons();

            } catch (e) {
                errorEl.textContent = `An error occurred: ${e.message}`;
                errorEl.classList.remove('hidden');
                outputEl.innerHTML = '';
            } finally {
                button.disabled = false;
                button.innerHTML = `<i data-lucide="sparkles" class="w-5 h-5 mr-2"></i>Generate Worksheet`;
                lucide.createIcons();
            }
        }


        // --- UTILITY FUNCTIONS ---
        function parseLessonPlan(text) {
            const getSection = (heading) => {
                const regex = new RegExp(`##\\s*${heading}\\s*\\n([\\s\\S]*?)(?=\\n##|$)`, 'i');
                const match = text.match(regex);
                return match ? match[1].replace(/\*\*|##|\*/g, '').trim() : '';
            };
            return {
                introduction: getSection('Introduction'),
                mainActivities: getSection('Main Activities'),
                plenary: getSection('Plenary') || getSection('Plenary / Conclusion'),
                resources: getSection('Resources'),
            };
        }
        
        function getWebResources(topic) {
            return [
                { title: `Search YouTube for "${topic}" videos`, snippet: `Find educational videos, songs, and animations.`, url: `https://www.youtube.com/results?search_query=${encodeURIComponent('educational ' + topic + ' for kids')}` },
                { title: `Find activities for "${topic}" on Google`, snippet: `Search for printable worksheets and games.`, url: `https://www.google.com/search?q=${encodeURIComponent(topic + ' classroom activities and worksheets')}` },
            ];
        }

        function createSectionHTML(icon, color, title, content) {
            let textContent = 'No content provided.';
            if (typeof content === 'string') {
                textContent = content.replace(/\n/g, '<br>');
            } else if (Array.isArray(content)) {
                textContent = `<ol class="list-decimal list-inside">${content.map(item => `<li>${item}</li>`).join('')}</ol>`;
            } else if (typeof content === 'object' && content !== null) {
                textContent = `<ol class="list-decimal list-inside">${Object.values(content).map(item => `<li>${item}</li>`).join('')}</ol>`;
            } else if (content) {
                textContent = String(content).replace(/\n/g, '<br>');
            }
            return `<div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200 break-inside-avoid"><h3 class="text-lg font-semibold text-gray-800 flex items-center mb-3"><i data-lucide="${icon}" class="text-${color}-500"></i><span class="ml-2">${title}</span></h3><div class="prose prose-sm max-w-none text-gray-600">${textContent}</div></div>`;
        }

        async function handleDownloadDoc(filename) {
            let printableAreaId;
            if (state.activeTab === 'lessonPlanner') printableAreaId = 'printable-plan';
            else if (state.activeTab === 'reportWriter') printableAreaId = 'printable-report';
            else if (state.activeTab === 'testCreator') printableAreaId = 'printable-test';
            else if (state.activeTab === 'worksheetCreator') printableAreaId = 'printable-worksheet';
            
            if (!printableAreaId) return;

            const content = document.getElementById(printableAreaId).innerHTML;
            const blob = await htmlToDocx.asBlob(content, {
                margins: { top: 720, right: 720, bottom: 720, left: 720 }
            });
            saveAs(blob, `${filename}.docx`);
        }

        // --- INITIAL RENDER ---
        render();
    </script>
</body>
</html>
