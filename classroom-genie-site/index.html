<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Classroom Genie</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts: Poppins -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body {
            font-family: 'Poppins', sans-serif;
            background-color: #f8fafc;
            background-image: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23d1e5e8' fill-opacity='0.4'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
        }
        .prose { max-width: 65ch; }
        .prose-sm { font-size: 0.875rem; line-height: 1.5; }
        @media print {
            body * { visibility: hidden; }
            #printable-plan, #printable-plan *,
            #printable-report, #printable-report * { visibility: visible; }
            #printable-plan, #printable-report {
                position: absolute; left: 0; top: 0; width: 100%; padding: 1rem; border: none;
            }
            .print-only-title { display: block !important; text-align: center; margin-bottom: 2rem; }
        }
    </style>
</head>
<body>
    <div class="min-h-screen">
        <div class="md:flex">
            <!-- Sidebar Navigation -->
            <aside id="sidebar" class="w-full md:w-64 bg-white p-4 md:h-screen md:sticky top-0 border-r border-gray-200 print:hidden">
                <div class="flex items-center mb-8">
                    <i data-lucide="brain-circuit" class="h-8 w-8 text-teal-500"></i>
                    <h1 class="ml-2 text-xl font-bold text-gray-800">Classroom Genie</h1>
                </div>
                <nav class="space-y-2">
                    <button data-tab="home" class="nav-link flex items-center w-full px-4 py-3 text-sm font-medium rounded-lg transition-all duration-200 bg-teal-600 text-white shadow-md">
                        <i data-lucide="home" class="h-5 w-5"></i><span class="ml-3">Home</span>
                    </button>
                    <button data-tab="lessonPlanner" class="nav-link flex items-center w-full px-4 py-3 text-sm font-medium rounded-lg transition-all duration-200 text-gray-600 hover:bg-gray-100">
                        <i data-lucide="book-open" class="h-5 w-5"></i><span class="ml-3">Lesson Plan Creator</span>
                    </button>
                    <button data-tab="reportWriter" class="nav-link flex items-center w-full px-4 py-3 text-sm font-medium rounded-lg transition-all duration-200 text-gray-600 hover:bg-gray-100">
                        <i data-lucide="file-text" class="h-5 w-5"></i><span class="ml-3">Report Writer</span>
                    </button>
                </nav>
            </aside>

            <!-- Main Content -->
            <main id="main-content" class="flex-1 p-4 md:p-8"></main>
        </div>
    </div>

    <script>
        // --- STATE MANAGEMENT ---
        let activeTab = 'home';
        const mainContent = document.getElementById('main-content');
        const navLinks = document.querySelectorAll('.nav-link');

        // --- TEMPLATES / VIEWS ---
        const homePageTemplate = `
            <div class="max-w-4xl mx-auto">
                <div class="bg-white p-8 md:p-12 rounded-xl shadow-xl border-t-4 border-teal-500 text-center">
                    <i data-lucide="sparkles" class="mx-auto h-16 w-16 text-teal-400"></i>
                    <h1 class="mt-4 text-4xl md:text-5xl font-bold text-gray-800">Welcome to Classroom Genie</h1>
                    <p class="mt-4 text-lg text-gray-600 max-w-2xl mx-auto">
                        Your ultimate AI-powered assistant for teaching. Save time on administrative tasks and focus on what truly matters: inspiring your students. Explore our free tools for lesson planning and report writing.
                    </p>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mt-10">
                    <div data-tab-link="lessonPlanner" class="group bg-white p-8 rounded-xl shadow-lg hover:shadow-2xl transition-shadow duration-300 cursor-pointer border-t-4 border-purple-400">
                        <i data-lucide="book-open" class="h-12 w-12 text-purple-500 mb-4"></i>
                        <h2 class="text-2xl font-bold text-gray-800">Lesson Plan Creator</h2>
                        <p class="mt-2 text-gray-600">Effortlessly generate detailed, engaging lesson plans tailored to your topic, objectives, and time constraints. Get web resources and ideas in seconds.</p>
                        <div class="flex items-center mt-6 font-semibold text-purple-600"><span>Start Planning</span><i data-lucide="arrow-right" class="ml-2 h-5 w-5 transition-transform duration-300 group-hover:translate-x-1"></i></div>
                    </div>
                    <div data-tab-link="reportWriter" class="group bg-white p-8 rounded-xl shadow-lg hover:shadow-2xl transition-shadow duration-300 cursor-pointer border-t-4 border-orange-400">
                        <i data-lucide="file-text" class="h-12 w-12 text-orange-500 mb-4"></i>
                        <h2 class="text-2xl font-bold text-gray-800">Report Writer</h2>
                        <p class="mt-2 text-gray-600">Upload student marks and add your comments to generate comprehensive, constructive, and personalized school reports automatically.</p>
                        <div class="flex items-center mt-6 font-semibold text-orange-600"><span>Write Reports</span><i data-lucide="arrow-right" class="ml-2 h-5 w-5 transition-transform duration-300 group-hover:translate-x-1"></i></div>
                    </div>
                </div>
            </div>`;

        const lessonPlannerTemplate = `
            <div class="max-w-4xl mx-auto">
                <div class="bg-white p-8 rounded-xl shadow-xl border-t-4 border-teal-500 print:hidden">
                    <h2 class="text-3xl font-bold text-gray-800 mb-2">Lesson Plan Creator</h2>
                    <p class="text-gray-500 mb-8">Design engaging lesson plans with AI-suggested web resources.</p>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                        <div><label for="topic" class="block text-sm font-medium text-gray-700 mb-1">Topic</label><input type="text" id="topic" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-teal-500 focus:border-teal-500" placeholder="e.g., The Water Cycle"></div>
                        <div class="flex items-center space-x-4">
                            <div><label for="duration" class="block text-sm font-medium text-gray-700 mb-1">Duration (min)</label><input type="number" id="duration" value="45" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-teal-500 focus:border-teal-500"></div>
                            <div><label for="language" class="block text-sm font-medium text-gray-700 mb-1">Language</label><select id="language" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-teal-500 focus:border-teal-500 bg-white"><option value="US">US English</option><option value="UK">UK English</option></select></div>
                        </div>
                        <div class="md:col-span-2"><label for="objectives" class="block text-sm font-medium text-gray-700 mb-1">Learning Objectives</label><textarea id="objectives" rows="3" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-teal-500 focus:border-teal-500" placeholder="e.g., Students will be able to name the stages of the water cycle."></textarea></div>
                    </div>
                    <button id="generate-plan-btn" class="w-full bg-teal-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-teal-700 transition-all duration-300 transform hover:scale-105 flex items-center justify-center disabled:bg-teal-300 disabled:scale-100 mb-8"><i data-lucide="sparkles" class="w-5 h-5 mr-2"></i>Generate Lesson Plan</button>
                    <div id="lp-error" class="text-red-500 text-sm mt-2 mb-6 hidden"></div>
                </div>
                <div id="lp-output" class="mt-8">
                    <div class="text-center p-12 bg-white rounded-xl shadow-lg border-t-4 border-gray-200">
                        <i data-lucide="lightbulb" class="mx-auto h-16 w-16 text-gray-300"></i>
                        <h3 class="mt-4 text-lg font-semibold text-gray-700">Your masterpiece awaits!</h3>
                        <p class="mt-1 text-gray-500">Fill out the form above to create your lesson plan.</p>
                    </div>
                </div>
            </div>`;

        const reportWriterTemplate = `
            <div class="max-w-4xl mx-auto">
                <div class="bg-white p-8 rounded-xl shadow-xl border-t-4 border-teal-500 print:hidden">
                    <h2 class="text-3xl font-bold text-gray-800 mb-2">Report Writer</h2>
                    <p class="text-gray-500 mb-8">Generate student reports from marks and your insights.</p>
                    <div class="space-y-6 mb-8">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Upload Marks</label>
                            <div class="mt-1 flex justify-center px-6 pt-5 pb-6 border-2 border-gray-300 border-dashed rounded-md"><div class="space-y-1 text-center"><i data-lucide="upload-cloud" class="mx-auto h-12 w-12 text-gray-400"></i><div class="flex text-sm text-gray-600"><label for="file-upload" class="relative cursor-pointer bg-white rounded-md font-medium text-teal-600 hover:text-teal-500 focus-within:outline-none focus-within:ring-2 focus-within:ring-offset-2 focus-within:ring-teal-500"><span>Upload a file</span><input id="file-upload" type="file" class="sr-only" accept=".pdf,.xls,.xlsx,.csv,.doc,.docx,.txt"></label><p class="pl-1">or drag and drop</p></div><p class="text-xs text-gray-500">PDF, Excel, CSV, Word up to 10MB</p></div></div>
                            <p id="file-name" class="text-sm text-gray-600 mt-2"></p>
                        </div>
                        <div><label for="studentName" class="block text-sm font-medium text-gray-700 mb-1">Student's Name</label><input type="text" id="studentName" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-teal-500 focus:border-teal-500" placeholder="e.g., Jane Doe"></div>
                        <div><label for="comments" class="block text-sm font-medium text-gray-700 mb-1">Additional Comments for Narrative Report</label><p class="text-sm text-gray-500 mb-2">Highly recommended. Adding your own insights helps the AI write a much richer, more personalized report.</p><textarea id="comments" rows="4" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-teal-500 focus:border-teal-500" placeholder="e.g., 'Shows great enthusiasm...'"></textarea></div>
                    </div>
                    <button id="generate-report-btn" class="w-full bg-teal-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-teal-700 transition-all duration-300 transform hover:scale-105 flex items-center justify-center disabled:bg-teal-300 disabled:scale-100"><i data-lucide="file-text" class="w-5 h-5 mr-2"></i>Generate Report</button>
                    <div id="rw-error" class="text-red-500 text-sm mt-2 hidden"></div>
                </div>
                <div id="rw-output" class="mt-8">
                    <div class="text-center p-12 bg-white rounded-xl shadow-lg border-t-4 border-gray-200">
                        <i data-lucide="lightbulb" class="mx-auto h-16 w-16 text-gray-300"></i>
                        <h3 class="mt-4 text-lg font-semibold text-gray-700">Your report will appear here.</h3>
                        <p class="mt-1 text-gray-500">Fill out the form above to get started.</p>
                    </div>
                </div>
            </div>`;

        // --- RENDER FUNCTIONS ---
        function render() {
            if (activeTab === 'home') mainContent.innerHTML = homePageTemplate;
            else if (activeTab === 'lessonPlanner') mainContent.innerHTML = lessonPlannerTemplate;
            else if (activeTab === 'reportWriter') mainContent.innerHTML = reportWriterTemplate;
            
            updateNavLinks();
            addEventListeners();
            lucide.createIcons();
        }

        function updateNavLinks() {
            navLinks.forEach(link => {
                if (link.dataset.tab === activeTab) {
                    link.classList.add('bg-teal-600', 'text-white', 'shadow-md');
                    link.classList.remove('text-gray-600', 'hover:bg-gray-100');
                } else {
                    link.classList.remove('bg-teal-600', 'text-white', 'shadow-md');
                    link.classList.add('text-gray-600', 'hover:bg-gray-100');
                }
            });
        }
        
        // --- EVENT LISTENERS ---
        function addEventListeners() {
            // Main navigation
            navLinks.forEach(link => {
                link.addEventListener('click', () => {
                    activeTab = link.dataset.tab;
                    render();
                });
            });

            // Home page links
            if (activeTab === 'home') {
                document.querySelectorAll('[data-tab-link]').forEach(link => {
                    link.addEventListener('click', () => {
                        activeTab = link.dataset.tabLink;
                        render();
                    });
                });
            }

            // Lesson Planner
            if (activeTab === 'lessonPlanner') {
                document.getElementById('generate-plan-btn').addEventListener('click', handleGenerateLessonPlan);
            }

            // Report Writer
            if (activeTab === 'reportWriter') {
                document.getElementById('generate-report-btn').addEventListener('click', handleGenerateReport);
                document.getElementById('file-upload').addEventListener('change', handleFileChange);
            }
        }
        
        // --- HANDLERS & LOGIC ---

        function handleFileChange(e) {
            const file = e.target.files[0];
            if (!file) return;
            const fileNameEl = document.getElementById('file-name');
            fileNameEl.textContent = `File: ${file.name}`;
            const reader = new FileReader();
            reader.onload = (event) => {
                // Store file content on a global or accessible object
                window.reportFileContent = event.target.result;
            };
            reader.readAsText(file);
        }

        async function handleGenerateLessonPlan() {
            const topic = document.getElementById('topic').value;
            const objectives = document.getElementById('objectives').value;
            const duration = document.getElementById('duration').value;
            const language = document.getElementById('language').value;
            const errorEl = document.getElementById('lp-error');
            const outputEl = document.getElementById('lp-output');
            const button = document.getElementById('generate-plan-btn');

            errorEl.classList.add('hidden');
            if (!topic || !objectives) {
                errorEl.textContent = 'Please fill in the Topic and Learning Objectives.';
                errorEl.classList.remove('hidden');
                return;
            }

            button.disabled = true;
            button.innerHTML = `<div class="animate-spin rounded-full h-5 w-5 border-b-2 border-white mr-3"></div> Generating...`;
            outputEl.innerHTML = `<div class="text-center text-gray-600"><p>Crafting your lesson plan...</p></div>`;

            const prompt = `Create a detailed lesson plan for a ${duration}-minute lesson. Topic: ${topic}. Learning Objectives: ${objectives}. Language: ${language} English. Format the response using these exact markdown headings: ## Introduction, ## Main Activities, ## Plenary, ## Resources, ## Visual Aid Ideas`;

            try {
                const response = await fetch('/.netlify/functions/generate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ prompt, isJson: false })
                });

                if (!response.ok) throw new Error(`API request failed with status ${response.status}`);
                
                const result = await response.json();
                const text = result.candidates[0].content.parts[0].text;
                
                // Parse and render plan
                const plan = parseLessonPlan(text);
                const webResources = getWebResources(topic);
                outputEl.innerHTML = `
                    <div class="bg-gray-50/50 p-6 rounded-lg">
                        <div class="flex justify-between items-center mb-6 print:hidden">
                            <h2 class="text-2xl font-bold text-gray-800">Your Lesson Plan</h2>
                            <button onclick="window.print()" class="flex items-center bg-gray-200 text-gray-800 font-semibold py-2 px-4 rounded-lg hover:bg-gray-300 transition-colors"><i data-lucide="printer" class="w-5 h-5 mr-2"></i>Print Plan</button>
                        </div>
                        <div id="printable-plan" class="space-y-6">
                             <h1 class="text-3xl font-bold text-center hidden print-only-title">Lesson Plan: ${topic}</h1>
                            ${createSection('target', 'green', 'Introduction', plan.introduction)}
                            ${createSection('list-checks', 'blue', 'Main Activities', plan.mainActivities)}
                            ${createSection('flag', 'purple', 'Plenary / Conclusion', plan.plenary)}
                            ${createSection('paperclip', 'orange', 'Resources', plan.resources)}
                            <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200 print:hidden">
                                <h3 class="text-lg font-semibold text-gray-800 flex items-center mb-4"><i data-lucide="video" class="text-pink-500"></i><span class="ml-2">Web Resources & Videos</span></h3>
                                <ul class="space-y-4">${webResources.map(r => `
                                    <li class="border-b border-gray-200 pb-3 last:border-b-0">
                                        <a href="${r.url}" target="_blank" rel="noopener noreferrer" class="font-semibold text-teal-600 hover:underline">${r.title}</a>
                                        <p class="text-sm text-gray-500 mt-1">${r.snippet}</p>
                                    </li>`).join('')}
                                </ul>
                            </div>
                        </div>
                    </div>`;
                lucide.createIcons();

            } catch (e) {
                errorEl.textContent = `An error occurred: ${e.message}`;
                errorEl.classList.remove('hidden');
                outputEl.innerHTML = '';
            } finally {
                button.disabled = false;
                button.innerHTML = `<i data-lucide="sparkles" class="w-5 h-5 mr-2"></i>Generate Lesson Plan`;
                lucide.createIcons();
            }
        }

        async function handleGenerateReport() {
            const studentName = document.getElementById('studentName').value;
            const comments = document.getElementById('comments').value;
            const fileContent = window.reportFileContent || '';
            const errorEl = document.getElementById('rw-error');
            const outputEl = document.getElementById('rw-output');
            const button = document.getElementById('generate-report-btn');

            errorEl.classList.add('hidden');
            if (!fileContent) { errorEl.textContent = 'Please upload a marks document.'; errorEl.classList.remove('hidden'); return; }
            if (!studentName) { errorEl.textContent = "Please enter the student's name."; errorEl.classList.remove('hidden'); return; }

            button.disabled = true;
            button.innerHTML = `<div class="animate-spin rounded-full h-5 w-5 border-b-2 border-white mr-3"></div> Generating...`;
            outputEl.innerHTML = `<div class="text-center text-gray-600"><p>Generating your report...</p></div>`;

            const prompt = `Based on the student data and teacher comments for ${studentName}, generate a JSON object with two keys: "marks_analysis" and "narrative_report". 1. "marks_analysis": Briefly summarize the key takeaways from the marks data in a few bullet points. 2. "narrative_report": Write a comprehensive and detailed school report that integrates the teacher's comments, analyzes the marks data, and concludes with areas for improvement. Maintain an encouraging tone. Do not use markdown. Student Marks Data: --- ${fileContent} --- Additional Teacher Comments: --- ${comments} ---`;

            try {
                const response = await fetch('/.netlify/functions/generate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ prompt, isJson: true })
                });

                if (!response.ok) throw new Error(`API request failed with status ${response.status}`);
                
                const result = await response.json();
                const jsonText = result.candidates[0].content.parts[0].text;
                const parsedResult = JSON.parse(jsonText);
                
                outputEl.innerHTML = `
                    <div class="bg-gray-50/50 p-6 rounded-lg">
                        <div class="flex justify-between items-center mb-6 print:hidden">
                            <h2 class="text-2xl font-bold text-gray-800">Generated Report</h2>
                            <button onclick="window.print()" class="flex items-center bg-gray-200 text-gray-800 font-semibold py-2 px-4 rounded-lg hover:bg-gray-300 transition-colors"><i data-lucide="printer" class="w-5 h-5 mr-2"></i>Print Report</button>
                        </div>
                        <div id="printable-report" class="space-y-6">
                            <h1 class="text-3xl font-bold text-center hidden print-only-title">School Report for ${studentName}</h1>
                            ${createSection('message-square', 'purple', 'Narrative Report', parsedResult.narrative_report)}
                            ${createSection('bar-chart-2', 'teal', 'Marks Analysis', parsedResult.marks_analysis)}
                        </div>
                    </div>`;
                lucide.createIcons();

            } catch (e) {
                errorEl.textContent = `An error occurred: ${e.message}`;
                errorEl.classList.remove('hidden');
                outputEl.innerHTML = '';
            } finally {
                button.disabled = false;
                button.innerHTML = `<i data-lucide="file-text" class="w-5 h-5 mr-2"></i>Generate Report`;
                lucide.createIcons();
            }
        }

        // --- UTILITY FUNCTIONS ---
        function parseLessonPlan(text) {
            const clean = (t) => t.replace(/\*\*|##|\*/g, '').trim();
            return {
                introduction: clean(text.match(/## Introduction\n([\s\S]*?)(?=\n## |$)/)?.[1] || ''),
                mainActivities: clean(text.match(/## Main Activities\n([\s\S]*?)(?=\n## |$)/)?.[1] || ''),
                plenary: clean(text.match(/## Plenary\n([\s\S]*?)(?=\n## |$)/)?.[1] || ''),
                resources: clean(text.match(/## Resources\n([\s\S]*?)(?=\n## |$)/)?.[1] || ''),
            };
        }
        
        function getWebResources(topic) {
            return [
                { title: `Search YouTube for "${topic}" videos`, snippet: `Find educational videos, songs, and animations about ${topic}.`, url: `https://www.youtube.com/results?search_query=${encodeURIComponent('educational ' + topic + ' for kids')}` },
                { title: `Find activities for "${topic}" on Google`, snippet: `Search for printable worksheets, activities, and games related to ${topic}.`, url: `https://www.google.com/search?q=${encodeURIComponent(topic + ' classroom activities and worksheets')}` },
            ];
        }

        function createSection(icon, color, title, content) {
            const textContent = Array.isArray(content) ? content.join('<br>') : String(content || '').replace(/\n/g, '<br>');
            return `
                <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200 break-inside-avoid">
                    <h3 class="text-lg font-semibold text-gray-800 flex items-center mb-3"><i data-lucide="${icon}" class="text-${color}-500"></i><span class="ml-2">${title}</span></h3>
                    <div class="prose prose-sm max-w-none text-gray-600">${textContent}</div>
                </div>`;
        }

        // --- INITIAL RENDER ---
        render();
    </script>
</body>
</html>
